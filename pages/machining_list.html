<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>农事助手</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link rel="stylesheet" href="../libs/css/mui.min.css">
		<link rel="stylesheet" href="../libs/css/mui.picker.min.css" />
		<link rel="stylesheet" href="../css/comm.css">
		<style type="text/css">
			.mbtenpx-list .mui-media-body p {
				position: relative;
				padding-left: 10px;
			}
			.mbtenpx-list .mui-media-body p span {
				display: inline-block;
				width: 4px;
				height: 4px;
				border-radius: 2px;
				position: absolute;
				top: 6px;
				left: 0;
			}
			.mbtenpx-list .mui-media-body p span.bggreen {
				background: #6EC73E;
			}
			.mbtenpx-list .mui-media-body p span.bgblue {
				background: #3ED4FF;
			}
			.mbtenpx-list .mui-media-body p span.bgpurple {
				background: #7DA7FA;
			}
			.imges_box {
				width: 100%;
				padding: 5px;
			}
			.imges_box img {
				max-width: 30%;
				max-height: 10%;
				margin: 0px 5px;
				float: left;
			}
			.mui-bar-tab .baozhuang_db {
				width: 50%;
				color: #777777;
				line-height: 30px;
				font-size: 14px;
				text-align: center;
				margin-top: 20px;
				float: left;
			}
			.mui-bar-tab .baozhuang_db:hover {
				width: 50%;
				color: #70C93E;
				line-height: 30px;
				font-size: 14px;
				text-align: center;
				margin-top: 20px;
				float: left;
			}
		</style>
	</head>

	<body>
		<div id="app"></div>
		<script type="text/x-template" id="indexTpl">
			<div>
				<header class="mui-bar mui-bar-nav" id="header">
					<div class="mui-action-back mui-pull-left navicon-back1"></div>
					<h1 class="mui-title">初加工</h1>
					<div class="mui-pull-right" style="line-height: 45px;" @tap="toMachiningAdd()">添加</div>
				</header>
				<!--查询条件-->
				<div class="mui-row query-condition-warpper" style="position: fixed;top: 65px;width: 100%;z-index: 100;">
					<div class="mui-col-xs-6 mui-ellipsis">
						<span @tap="selectRecovery">{{batchId || '全部批次'}}</span>
						<img src="../images/jidi_icon_down.png" width="8px" />
					</div>
					<div class="mui-col-xs-6 mui-ellipsis">
						<span @tap="selectHandleUser">{{handleUserName}}</span>
						<img src="../images/jidi_icon_down.png" width="8px" />
					</div>
				</div>
				<div class="mui-content" style="padding-top: 80px;">
					<!--列表-->
					<div id="pullrefresh">
						<div class="mui-scroll">
							<ul class="mui-table-view mbtenpx-list">
								<li class="mui-table-view-cell mui-media" v-for="d in machiningList">
									<div class="mui-row">
										<div class="mui-col-xs-9">
											<div class="mui-media-body">
												<span class="fruit-name mui-ellipsis" style="font-size: 16px;width: 88%;">{{d.remark == 'undefined' ? '' : d.remark}}</span>
												<p class='mui-ellipsis'><span class="bggreen"></span>批次号：{{d.batchId}}</p>
												<p class='mui-ellipsis'><span class="bgblue"></span>加工方法：{{d.method}} </p>
												<p class='mui-ellipsis'><span class="bgblue"></span>加工工艺：{{d.technology}} </p>
												<p class='mui-ellipsis'><span class="bgpurple"></span>加工设备：{{d.equipment}}</p>
											</div>
										</div>
										<div class="mui-col-sm-3 mui-col-xs-3 right">
											<div class="mui-pull-right">
												<p class='mui-ellipsis base-area'>{{d.startOperationTime}} 至 {{d.endOperationTime}}</p>
											</div>
										</div>
									</div>
									<div class="mui-row imges_box">
										<img :src="d.imgurl" alt="" @tap="previewImage(d.imgurl)" />
									</div>
									<div class="mui-row edit-item">
										<h6 class="mui-col-sm-6 mui-col-xs-6">操作人：{{d.operationUsername}}</h6>
										<h6 class="mui-col-sm-3 mui-col-xs-3"><span class="mui-icon mui-icon mui-icon-compose" @tap="toUpdateMachining(d)"></span><span @tap="toUpdateMachining(d)">编辑</span></h6>
										<h6 class="mui-col-sm-3 mui-col-xs-3"><span class="mui-icon mui-icon mui-icon mui-icon-trash" @tap="deleteMachining(d.processId)"></span><span @tap="deleteMachining(d.processId)">删除</span></h6>
									</div>
								</li>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</script>
	</body>
	<script src="../libs/js/mui.min.js"></script>
	<script src="../libs/js/vue.min.js"></script>
	<script src="../libs/js/mui.picker.min.js"></script>
	<script src="../js/comm.js"></script>

	<script>
		var vm = new Vue({
			el: '#app',
			template: indexTpl,
			data: function() {
				return {
					loginUserInfo: JSON.parse(localStorage.getItem('loginUserInfo')),
					// 选择操作人
					pageSize: 10,
					pageNum: 1,
					pageTatol: 0,
					//批次号（筛选条件）
					batchId: '',
					//操作人Id（筛选条件）
					operationUserId: '',
					// 操作人名字
					handleUserName: '全部操作人',
					// 初加工列表
					machiningList: [],
					// 采收人选择列表
					handleUserList: [{
						value: '',
						text: '全部操作人'
					}],
					// 批次列表
					RecoveryList: [{
						value: '',
						text: '全部批次'
					}],
				}
			},
			mounted: function() {
				// 获取操作人
				this.getUserList();
				// 获取批次号
				this.getmachiningList();
				// 监听refresh事件刷新页面
				window.addEventListener('refresh', function(e) {
					vm.pageNum = 1;
					vm.getInitialProcessList(false);
				})
				mui.plusReady(function() {
					plus.webview.currentWebview().setStyle({
						scrollIndicator: 'none'
					});
				})
				/**
				 * 下拉加载分页初始化
				 */
				mui.init({
					swipeBack: false,
					pullRefresh: {
						container: '#pullrefresh',
						down: {
							style: 'circle',
							offset: '105px',
							auto: true,
							callback: function() {
								vm.pageNum = 1;
								vm.getInitialProcessList(false, function() {
									mui('#pullrefresh').pullRefresh().endPulldown();
								});
							}
						},
						up: {
							contentrefresh: '正在加载...',
							callback: function() {
								++vm.pageNum;
								vm.getInitialProcessList(true);
								mui('#pullrefresh').pullRefresh().endPullupToRefresh((vm.pageNum > vm.pageTatol));
							}
						}
					}
				});
			},
			methods: {
				/**
				 * 选择操作人
				 */
				selectHandleUser: function() {
					offPullrefresh();
					var vm = this;
					var userPicker = new mui.PopPicker();
					userPicker.show(function(items) {
						vm.operationUserId = items[0].value;
						vm.handleUserName = items[0].text;
						vm.pageNum = 1;
						onPullrefresh();
						vm.getInitialProcessList(false);
						console.log(vm.operationUserId)
					});
					userPicker.setData(vm.handleUserList);
				},
				/**
				 * 获取操作人员列表
				 */
				getUserList: function() {
					var vm = this;
					getDataList(APIURL + 'business/user/list', {
						enterpriseId: vm.loginUserInfo.enterpriseId,
					}, function(d) {
						if(d && d.state === 0) {
							if(d.aaData) {
								for(var i in d.aaData) {
									var obj = {
										value: d.aaData[i].userId,
										text: d.aaData[i].nickName
									};
									vm.handleUserList.push(obj);
								}
							}
						}
					})
				},
				/**
				 * 选择批次
				 */
				selectRecovery: function() {
					offPullrefresh();
					var vm = this;
					var userPicker = new mui.PopPicker();
					userPicker.show(function(items) {
						vm.batchId = items[0].value;
						vm.pageNum = 1;
						onPullrefresh();
						vm.getInitialProcessList(false);
						console.log(vm.batchId)
					});
					userPicker.setData(vm.RecoveryList);
				},
				// 获取批次号列表
				getmachiningList: function() {
					var vm = this;
					getDataList(APIURL + 'business/recovery/queryRecoveryList', {
						enterpriseId: vm.loginUserInfo.enterpriseId,
					}, function(d) {
						if(d && d.state === 0) {
							if(d.aaData) {
								for(var i in d.aaData) {
									var obj = {
										value: d.aaData[i].batchId,
										text: d.aaData[i].batchId
									};
									vm.RecoveryList.push(obj);
								}
							}
						}
					})
				},
				/**
				 * 获取初加工展示列表
				 * @param {Object} isUp
				 */
				getInitialProcessList: function(isUp, cb) {
					var vm = this;
					getDataList(APIURL + 'business/initialProcess/list', {
						enterpriseId: vm.loginUserInfo.enterpriseId,
						pageSize: vm.pageSize,
						pageNum: vm.pageNum,
						batchId: vm.batchId,
						operationUserId: vm.operationUserId
					}, function(d) {
						if(d && d.state === 0) {
							if(d.aaData) {
								// 处理图片显示
								for(var i in d.aaData) {
									if(d.aaData[i].photo) {
										d.aaData[i].imgurl = IMGURL + d.aaData[i].photo + '&image/jpeg';
									}
									d.aaData[i].startOperationTime = d.aaData[i].startOperationTime.split(' ')[0];
									d.aaData[i].endOperationTime = d.aaData[i].endOperationTime.split(' ')[0];
								}

								if(isUp) {
									vm.machiningList = vm.machiningList.concat(d.aaData);
								} else {
									vm.machiningList = d.aaData;
									vm.pageTatol = Math.ceil(d.dataCount / vm.pageSize);
								}
							} else {
								if(!isUp) {
									vm.machiningList = [];
								}
								mui.toast('没有更多数据了')
							}
						}
						cb && cb();
					})
				},
				/**
				 * 跳转新增初加工
				 */
				toMachiningAdd: function() {
					mui.openWindow({
						url: 'machining_list_add.html',
						id: 'machining_list_add'
					})
				},
				/**
				 * 跳转编辑初加工
				 * @param {String} processId
				 */
				toUpdateMachining: function(item) {
					mui.openWindow({
						url: 'machining_list_add.html',
						id: 'machining_list_add',
						extras: {
							item: item
						}
					})
				},
				/**
				 * 删除加工
				 * @param {String} processId
				 */
				deleteMachining: function(processId) {
					var vm = this;
					var msg = '确认删除?';
					var title = '提示';
					var btnValue = ['确认', '取消'];
					mui.confirm(msg, title, btnValue, function(e) {
						if(e.index == 0) {
							getDataList(APIURL + 'business/initialProcess/delete', {
								processId: processId,
								enterpriseId: vm.loginUserInfo.enterpriseId
							}, function(d) {
								if(d && d.state === 0) {
									// 先删除列表数据中的
									for(var i in vm.machiningList) {
										if(vm.machiningList[i].processId == processId) {
											vm.machiningList.splice(i, 1);
										}
									}
									mui.toast('删除成功');
								} else {
									mui.toast('删除失败');
								}
							})
						}
					})
				},
				/**
				 * 预览图片
				 */
				previewImage: function(url) {
					var arr = [url]
					plus.nativeUI.previewImage(arr);
				}
			}
		});
	</script>
	<script src="../js/immersed.js"></script>

</html>