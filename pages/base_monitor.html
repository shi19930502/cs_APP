<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>农事助手</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link rel="stylesheet" href="../libs/css/mui.min.css">
		<link href="../libs/css/mui.picker.css" rel="stylesheet" />
		<link href="../libs/css/mui.poppicker.css" rel="stylesheet" />
		<link rel="stylesheet" href="../css/comm.css">
		<style type="text/css">
			/*视屏容器满屏*/
			
			.mui-table-view-cell {
				padding: 0 0 44px;
			}
			
			.video-warper {
				width: 100%;
				height: 180px;
				background: #000;
				position: relative;
			}
			
			.video-warper .video-shadow {
				width: 100%;
				height: 100%;
				position: absolute;
				top: 0;
				left: 0;
			}
			
			.video-warper .video-shadow h5 {
				color: #fff;
				padding: 8px 16px;
			}
			
			.video-warper .video-shadow .video-datatime {
				width: 100%;
				position: absolute;
				bottom: 0;
				overflow: hidden;
				padding: 8px 16px;
			}
			
			.video-warper .video-shadow .video-datatime p {
				color: #fff;
			}
			
			.video-warper .video-play-btn {
				width: 40px;
				height: 40px;
				background: url("../images/jidi_icon_bofang.png");
				background-size: 100% 100%;
				position: absolute;
				top: 50%;
				left: 50%;
				margin-top: -20px;
				margin-left: -20px;
			}
			
			.mbtenpx-list .mui-table-view-cell {
				padding-bottom: 45px;
			}
			
			.mui-scroll-wrapper {
				top: 85px;
			}
		</style>
	</head>

	<body>
		<div id="app">
			<index-view></index-view>
		</div>
		<script type="text/x-template" id="indexTpl">
			<div>
				<header class="mui-bar mui-bar-nav" id="header">
					<div class="mui-action-back mui-pull-left navicon-back1"></div>
					<div class="mui-action-back mui-pull-left back-text">返回</div>
					<h1 id="title" class="mui-title">监控</h1>
					<div class="mui-pull-right navicon-add" @tap="goBaseMainAdd()"></div>
				</header>
				<div class="mui-content">
					<!--查询条件-->
					<div class="mui-row query-condition-warpper">
						<div class="mui-col-xs-12 mui-ellipsis" @tap="getMonitorBybaseId">
							<span>{{baseName}}</span>
							<img src="../images/jidi_icon_down.png" width="8px" />
						</div>
					</div>
					<div id="pullrefresh" class="mui-scroll-wrapper">
						<template v-if="monitorList.length > 0">
							<div class="mui-scroll">
								<ul class="mui-table-view mbtenpx-list">
									<li class="mui-table-view-cell mui-media" v-for="d in monitorList">
										<!--视频容器-->
										<div class="video-warper">
											<div class="video-shadow">
												<h5>{{d.name}}</h5>
												<div class="video-datatime">
													<p class="fl">2017-10-14</p>
													<p class="fr">05:36</p>
												</div>
												<div class="video-play-btn"></div>
											</div>
										</div>
										<div class="mui-row edit-item">
											<h6 class="mui-col-sm-6 mui-col-xs-6">{{d.pName}}</h6>
											<h6 class="mui-col-sm-3 mui-col-xs-3" @tap="toEditMonitor(d.relationId)"><span class="mui-icon mui-icon mui-icon-compose"></span>编辑</h6>
											<h6 class="mui-col-sm-3 mui-col-xs-3" @tap="deleteMonitor(d.relationId)"><span class="mui-icon mui-icon mui-icon mui-icon-trash"></span>删除</h6>
										</div>
									</li>
								</ul>
							</div>
						</template>
						<!--暂无数据-->
						<template v-else>
							<div class="nodata">
								<img src="../images/nodata.png" />
							</div>
						</template>
					</div>
				</div>
			</div>
		</script>
	</body>
	<script src="../libs/js/mui.min.js"></script>
	<script src="../libs/js/vue.min.js"></script>
	<script src="../libs/js/mui.picker.js"></script>
	<script src="../libs/js/mui.poppicker.js"></script>
	<script src="../js/components.js"></script>
	<script src="../js/comm.js"></script>
	<script type="text/javascript">
		var vm = new Vue({
			el: '#app',
			template: indexTpl,
			data: function() {
				return {
					loginUserInfo: JSON.parse(localStorage.getItem('loginUserInfo')),
					pageSize: 10,
					pageNum: 1,
					// 基地查询条件
					baseId: '',
					baseName: '全部基地',
					// 总页数
					pageTatol: 0,
					monitorList: [],
					// 基地选择列表
					baseList: [{
						value: '',
						text: '全部基地'
					}],

				}
			},
			mounted: function() {
				var vm = this;
				// 初始化列表
				this.getBaseEquipment(false);
				// 获取基地列表
				this.getBaseList();
				// 初始化下拉刷新下拉加载
				mui.init({
					swipeBack: false,
					pullRefresh: {
						container: '#pullrefresh',
						up: {
							contentrefresh: '正在加载...',
							callback: function() {
								setTimeout(function() {
									++vm.pageNum;
									vm.getBaseEquipment(true);
									mui('#pullrefresh').pullRefresh().endPullupToRefresh((vm.pageNum > vm.pageTatol));
								}, 1000);
							}
						}
					}
				});
			},
			methods: {
				// 获取监控列表
				getBaseEquipment: function(isUp) {
					var vm = this;
					getDataList(APIURL + 'business/baseEquipment/list', {
						enterpriseId: vm.loginUserInfo.enterpriseId,
						baseId: vm.baseId,
						pageSize: vm.pageSize,
						pageNum: vm.pageNum
					}, function(d) {
						if(d.aaData && d.aaData.length > 0) {
							if(isUp) {
								vm.monitorList.concat(d.aaData);
							} else {
								vm.monitorList = d.aaData;
								vm.pageTatol = Math.ceil(d.dataCount / vm.pageSize);
							}
						} else {
							if(!isUp) {
								vm.monitorList = [];
							}
						}
					})
				},
				// 根据基地查询监控列表
				getMonitorBybaseId: function() {
					var vm = this;
					var userPicker = new mui.PopPicker();
					userPicker.show(function(items) {
						vm.baseName = items[0].text;
						vm.baseId = items[0].value;
						vm.getBaseEquipment(false);
					});
					userPicker.setData(vm.baseList);
				},
				// 获取基地列表
				getBaseList: function() {
					var vm = this;
					getDataList(APIURL + 'business/planBase/list', {
						enterpriseId: vm.loginUserInfo.enterpriseId,
					}, function(d) {
						if(d && d.state === 0) {
							if(d.aaData) {
								for(var i in d.aaData) {
									var obj = {
										value: d.aaData[i].baseId,
										text: d.aaData[i].name
									}
									vm.baseList.push(obj);
								}
							}
						}
					});
				},
				// 跳转添加监控
				goBaseMainAdd: function() {
					mui.openWindow({
						url: 'base_monitor_add.html',
						id: 'base_monitor_add',
					})
				},
				// 编辑监控
				toEditMonitor: function(relationId) {
					mui.openWindow({
						url: 'base_monitor_add.html',
						id: 'base_monitor_add',
						extras: {
							relationId: relationId
						}
					})
				},
				// 删除监控
				deleteMonitor: function(relationId) {
					var vm = this;
					var msg = '确认删除?';
					var title = '提示';
					var btnValue = ['确认', '取消'];
					mui.confirm(msg, title, btnValue, function(e) {
						if(e.index == 0) {
							getDataList(APIURL + 'business/baseEquipment/delete', {
								relationId: relationId
							}, function(d) {
								if(d && d.state === 0) {
									// 先删除列表数据中的
									for(var i in vm.monitorList) {
										if(vm.monitorList[i].relationId == relationId) {
											vm.monitorList.splice(i, 1);
										}
									}
									mui.toast('删除成功');
								} else {
									mui.toast('删除失败');
								}
							})
						}
					})
				}
			}
		});
	</script>
	<script src="../js/immersed.js"></script>

</html>