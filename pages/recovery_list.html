<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>农事助手</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link rel="stylesheet" href="../libs/css/mui.min.css">
		<link rel="stylesheet" href="../libs/css/mui.picker.min.css" />
		<link rel="stylesheet" href="../css/comm.css">
		<link rel="stylesheet" href="../css/recovery_list.css">
		<style type="text/css">
			.daics-wrapper {
				padding: 10px 15px;
				padding-right: 0;
				background: #fff;
				border-bottom: 1px solid #c8c7cc;
			}
			.daics-wrapper div {
				height: 42px;
				line-height: 42px;
			}
			.daics-wrapper div:nth-child(1) img {
				width: 42px;
				height: 42px;
			}
			.daics-wrapper div:nth-child(3) {
				position: relative;
				text-align: right;
			}
			.daics-wrapper div:nth-child(3) .mui-badge {
				background: #E44B60;
				color: #fff;
				padding: 5px 8px;
				position: absolute;
				right: 25px;
				top: 9px;
			}
			.daics-wrapper div:nth-child(3) .mui-icon {
				font-size: 28px;
			}
			.mbtenpx-list .mui-media-body p {
				position: relative;
				padding-left: 10px;
			}
			.mbtenpx-list .mui-media-body p span {
				display: inline-block;
				width: 4px;
				height: 4px;
				border-radius: 2px;
				position: absolute;
				top: 6px;
				left: 0;
			}
			.mbtenpx-list .mui-media-body p span.bggreen {
				background: #6EC73E;
			}
			.mbtenpx-list .mui-media-body p span.bgblue {
				background: #3ED4FF;
			}
			.mbtenpx-list .mui-media-body p span.bgpurple {
				background: #7DA7FA;
			}
		</style>
	</head>

	<body>
		<div id="app"></div>
		<script type="text/x-template" id="indexTpl">
			<div>
				<!--<header class="mui-bar mui-bar-nav" id="header">
					<div class="mui-action-back mui-pull-left navicon-back1"></div>
					<div class="mui-action-back mui-pull-left back-text">返回</div>
					<h1 class="mui-title">采收</h1>
					<div class="mui-pull-right navicon-add" @tap="toRecoveryAdd()"></div>
				</header>-->
				<div style="width: 100%; position: fixed;z-index: 100;top: 0px;">
					<!--查询条件-->
					<div class="mui-row query-condition-warpper">
						<div class="mui-col-sm-4 mui-col-xs-4 mui-ellipsis" @tap="selectBase">
							<span id="baseResult">全部基地</span>
							<img src="../images/jidi_icon_down.png" width="8px" />
						</div>
						<div class="mui-col-sm-4 mui-col-xs-4 mui-ellipsis" @tap="selectRecoveryUser">
							<span id="recoveryUserResult">全部采收人</span>
							<img src="../images/jidi_icon_down.png" width="8px" />
						</div>
						<div class="mui-col-sm-4 mui-col-xs-4 mui-ellipsis" @tap="selectHandleUser">
							<span id="HandleUserResult">全部经办人</span>
							<img src="../images/jidi_icon_down.png" width="8px" />
						</div>
					</div>
				</div>

				<div class="mui-content" style="padding-top: 40px;">
					<!--数据列表-->
					<div id="pullrefresh">
						<ul class="mui-table-view mbtenpx-list">
							<li class="mui-table-view-cell mui-media" v-for="d in recoveryList">
								<div class="mui-row">
									<div class="mui-col-sm-9 mui-col-xs-9">
										<div class="mui-media-body">
											<span class="fruit-name" style="font-size: 16px;">{{d.no}}</span>
											<p class='mui-ellipsis'><span class="bggreen"></span>批次号：{{d.batchId}}</p>
											<p class='mui-ellipsis'><span class="bgblue"></span>采收人：{{d.recoveryUsername}} </p>
											<p class='mui-ellipsis'><span class="bgblue"></span>经办人：{{d.handleUsername}}</p>
											<p class='mui-ellipsis'><span class="bgpurple"></span>采收信息：{{d.remark}}</p>
										</div>
									</div>
									<div class="mui-col-sm-3 mui-col-xs-3 right">
										<div class="mui-pull-right">
											<p class='mui-ellipsis base-area'>{{d.operationDate}}</p>
										</div>
									</div>
								</div>
								<div class="mui-row edit-item">
									<h6 class="mui-col-sm-6 mui-col-xs-6">基地 {{d.baseName}}</h6>
									<h6 class="mui-col-sm-3 mui-col-xs-3">
										<span class="mui-icon mui-icon mui-icon-compose" @tap="toEdit(d)"></span>
										<span @tap="toEdit(d)">编辑</span>
									</h6>
									<h6 class="mui-col-sm-3 mui-col-xs-3"><span class="mui-icon mui-icon mui-icon mui-icon-trash" @tap="deleteByRecoveryId(d.recoveryId)"></span><span @tap="deleteByRecoveryId(d.recoveryId)">删除</span></h6>
								</div>
							</li>
						</ul>
					</div>
				</div>
			</div>
		</script>

	</body>
	<script src="../libs/js/mui.min.js"></script>
	<script src="../libs/js/vue.min.js"></script>
	<script src="../libs/js/mui.picker.min.js"></script>
	<script src="../js/comm.js"></script>

	<script>
		var vm = new Vue({
			el: '#app',
			template: indexTpl,
			data: function() {
				return {
					loginUserInfo: JSON.parse(localStorage.getItem('loginUserInfo')),
					// 采收列表数据
					recoveryList: [],
					pageTatol: 0,
					// 是否选择日期
					isAll: true,
					// 是否第一次选择
					isFrist: true,
					pageSize: 10,
					pageNum: 0,
					startTime: '',
					endTime: '',
					handleUserId: '',
					recoveryUserId: '',
					baseId: '',
					// 基地选择列表
					baseList: [{
						value: '',
						text: '全部基地'
					}],
					// 采收人选择列表
					handleUserList: [{
						value: '',
						text: '全部经办人'
					}],
					// 经办人选择列表
					recoveryUserList: [{
						value: '',
						text: '全部采收人'
					}],
				}
			},
			watch: {
				startTime: function(val) {
					var startTime = val.replace(/-/g, '');
					var endTime = vm.endTime.replace(/-/g, '');
					if(startTime - endTime < 0) {
						mui.alert('开始时间不能大于结束时间请重新选择')
					}
				},
				endTime: function(val) {
					var endTime = val.replace(/-/g, '');
					var startTime = vm.startTime.replace(/-/g, '');
					if(endTime - startTime < 0) {
						mui.alert('结束时间不能小于开始时间请重新选择')
					} else {
						vm.getRecoveryList(false);
					}
				}
			},
			mounted: function() {
				this.getUserList();
				this.getBaseList();
				// 监听refresh事件刷新页面
				window.addEventListener('refresh', function(e) {
					vm.pageNum = 1;
					vm.getRecoveryList(false);
				})
				/**
				 * 下拉加载分页初始化
				 */
				mui.init({
					swipeBack: false,
					pullRefresh: {
						container: '#pullrefresh',
						down: {
							style: 'circle',
							offset: '40px',
							auto: true,
							callback: function() {
								vm.pageNum = 1;
								vm.getRecoveryList(false, function() {
									mui('#pullrefresh').pullRefresh().endPulldown();
								});
							}
						},
						up: {
							contentrefresh: '正在加载...',
							callback: function() {
								++vm.pageNum;
								vm.getRecoveryList(true);
								mui('#pullrefresh').pullRefresh().endPullupToRefresh((vm.pageNum > vm.pageTatol));
							}
						}
					}
				});
				mui.plusReady(function() {
					var self = plus.webview.currentWebview();
					var titleView = self.getNavigationbar();
					if(!titleView) {
						titleView = plus.webview.getLaunchWebview().getNavigationbar();
					}
					//开启回弹
					self.setStyle({
						bounce: "vertical",
						bounceBackground: "#ffffff",
					});
					// 绘制添加按钮
					titleView.drawText('添加', {
						top: "10px",
						right: "10px",
						height: "24px"
					}, {
						align: 'right',
						color: '#fff',
						size: '17px'
					});
					// 是否拦截View控件的触屏事件
					titleView.interceptTouchEvent(true);
					// 下一步点击事件
					titleView.addEventListener("click", function(e) {
						var x = e.clientX;
						if(x > 300) {
							vm.toRecoveryAdd();
						}
					})
				})
			},
			methods: {
				/**
				 * 获取采收列表数据
				 * @param {Object} isUp
				 * @param {Object} cb
				 */
				getRecoveryList: function(isUp, cb) {
					getDataList(APIURL + 'business/recovery/queryRecoveryList', {
						enterpriseId: this.loginUserInfo.enterpriseId,
						pageSize: this.pageSize,
						pageNum: this.pageNum,
						startTime: this.startTime,
						endTime: this.endTime,
						handleUserId: this.handleUserId,
						recoveryUserId: this.recoveryUserId,
						baseId: this.baseId
					}, function(d) {
						if(d && d.state === 0) {
							this.pageTatol = Math.ceil(d.dataCount / this.pageSize);
							if(d.aaData && d.aaData.length > 0) {
								if(isUp) {
									this.recoveryList = vmthisrecoveryList.concat(d.aaData);
								} else {
									this.recoveryList = d.aaData;
								}
							} else {
								if(!isUp) {
									this.recoveryList = [];
								}
								mui.toast('没有更多数据了')
							}
						}
						cb && cb();
					}.bind(this))
				},
				/**
				 * 获取基地选择列表
				 */
				getBaseList: function() {
					getDataList(APIURL + 'business/planBase/list', {
						enterpriseId: this.loginUserInfo.enterpriseId,
					}, function(d) {
						if(d && d.state === 0) {
							if(d.aaData) {
								for(var i in d.aaData) {
									var obj = {
										value: d.aaData[i].baseId,
										text: d.aaData[i].name
									}
									this.baseList.push(obj);
								}
							}
						}
					}.bind(this));
				},
				/**
				 * 获取人员选择列表
				 */
				getUserList: function() {
					getDataList(APIURL + 'business/user/list', {
						enterpriseId: this.loginUserInfo.enterpriseId,
					}, function(d) {
						if(d && d.state === 0) {
							if(d.aaData) {
								for(var i in d.aaData) {
									var obj = {
										value: d.aaData[i].userId,
										text: d.aaData[i].nickName
									};
									this.handleUserList.push(obj);
									this.recoveryUserList.push(obj);
								}
							}
						}
					}.bind(this))
				},
				/**
				 * 选择基地
				 */
				selectBase: function() {
					offPullrefresh();
					var userPicker = new mui.PopPicker();
					var userResult = document.getElementById('baseResult');
					this.pageNum = 1;
					userPicker.show(function(items) {
						userResult.innerText = items[0].text;
						this.baseId = items[0].value;
						this.pageNum = 1;
						onPullrefresh();
						this.getRecoveryList(false);
						console.log(this.baseId)
					}.bind(this));
					userPicker.setData(this.baseList);
				},
				/**
				 * 选择采收人
				 */
				selectRecoveryUser: function() {
					offPullrefresh();
					var userPicker = new mui.PopPicker();
					var userResult = document.getElementById('recoveryUserResult');
					userPicker.show(function(items) {
						userResult.innerText = items[0].text;
						this.recoveryUserId = items[0].value;
						this.pageNum = 1;
						onPullrefresh();
						this.getRecoveryList(false);
						console.log(this.recoveryUserId)
					}.bind(this));
					userPicker.setData(this.recoveryUserList);
				},
				/**
				 * 选择经办人
				 */
				selectHandleUser: function() {
					offPullrefresh();
					var userPicker = new mui.PopPicker();
					var userResult = document.getElementById('HandleUserResult');
					userPicker.show(function(items) {
						userResult.innerText = items[0].text;
						this.handleUserId = items[0].value;
						this.pageNum = 1;
						onPullrefresh();
						this.getRecoveryList(false);
						console.log(this.handleUserId)
					}.bind(this));
					userPicker.setData(this.handleUserList);
				},
				/**
				 * 待采收
				 */
				toRecoveryWait: function() {
					mui.openWindow({
						url: 'recovery_wait_list.html',
						id: 'recovery_wait_list'
					})
				},
				/**
				 * 新增采收
				 */
				toRecoveryAdd: function() {
					mui.openWindow({
						url: 'recovery_add.html',
						id: 'recovery_add',
						styles: {
							titleNView: { // 窗口的标题栏控件
								titleText: "新增采收",
								backgroundColor: "#70C93E",
								titleColor: "#fff",
								autoBackButton: true,
								titleSize: "18px",
							}
						}
					})
				},
				/**
				 * 编辑采收
				 * @param {Object} d
				 */
				toEdit: function(d) {
					mui.openWindow({
						url: 'recovery_add.html',
						id: 'recovery_add',
						extras: {
							editItem: d
						},
						styles: {
							titleNView: { // 窗口的标题栏控件
								titleText: "编辑采收",
								backgroundColor: "#70C93E",
								titleColor: "#fff",
								autoBackButton: true,
								titleSize: "18px",
							}
						}
					})
				},
				/**
				 * 查看采收
				 * @param {Object} d
				 */
				toFind: function(d) {
					mui.openWindow({
						url: 'recovery_add.html',
						id: 'recovery_add',
						extras: {
							editItem: d,
							find: 'true'
						}
					})
				},
				/**
				 * 时间选择器
				 * @param {Object} type
				 */
				datePicker: function(type) {
					var vm = this;
					var dtPicker = new mui.DtPicker({
						type: 'date'
					});

					if(type == 'start') {
						dtPicker.show(function(rs) {
							vm.startTime = rs.text;
						})
					} else if(type == 'end') {
						dtPicker.show(function(rs) {
							vm.endTime = rs.text;
						})
					} else {
						if(vm.isFrist) {
							vm.isFrist = false;
							dtPicker.show(function(rs) {
								vm.startTime = rs.text;
							})
						} else {
							dtPicker.show(function(rs) {
								vm.endTime = rs.text;
								vm.isAll = false;
							})
						}
					}
				},
				/**
				 * 获取全部日期数据
				 */
				getAll: function() {
					this.isAll = true;
					this.isFrist = true;
					this.startTime = '';
					this.endTime = '';
				},
				/**
				 * 删除采收列表
				 * @param {Object} recoveryId
				 */
				deleteByRecoveryId: function(recoveryId) {
					var vm = this;
					var msg = '确认删除?';
					var title = '提示';
					var btnValue = ['确认', '取消'];
					mui.confirm(msg, title, btnValue, function(e) {
						if(e.index == 0) {
							getDataList(APIURL + 'business/recovery/deleteByRecoveryId', {
								recoveryId: recoveryId,
								enterpriseId: vm.loginUserInfo.enterpriseId
							}, function(d) {
								if(d && d.state === 0) {
									// 先删除列表数据中的
									for(var i in vm.recoveryList) {
										if(vm.recoveryList[i].recoveryId == recoveryId) {
											vm.recoveryList.splice(i, 1);
										}
									}
									mui.toast('删除成功');
								} else {
									mui.toast('删除失败');
								}
							})
						}
					})
				}
			}
		});
	</script>

</html>