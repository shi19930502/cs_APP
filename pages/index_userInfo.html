<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>农事助手</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link rel="stylesheet" href="../libs/css/mui.min.css">
		<link rel="stylesheet" href="../css/comm.css">

		<style>
			.navicon-edit {
				margin-right: 12px;
			}
			.headimg-warpper {
				width: 100%;
				height: 110px;
				background: #70C93E;
				position: relative;
			}
			.headimg-warpper .headimg {
				width: 80px;
				height: 80px;
				background: #fff;
				border-radius: 40px;
				padding: 2px;
				position: absolute;
				top: 50%;
				left: 50%;
				margin-top: -40px;
				margin-left: -40px;
			}
			.headimg-warpper .headimg img {
				width: 100%;
				height: 100%;
				border-radius: 40px;
			}
			.userinfo-warpper {
				padding: 20px 15px 10px;
				background: #fff;
				margin-bottom: 10px;
			}
			.userinfo-warpper p {
				overflow: hidden;
			}
			.userinfo-warpper p span:nth-child(1) {
				display: inline-block;
				width: 60px;
				/*margin-right: 40px;*/
				float: left;
			}
			.userinfo-warpper p span:nth-child(2) {
				color: #4C4C4C;
				float: right;
				width: 75%;
			}
		</style>
	</head>

	<body>
		<div id="app"></div>
		<script type="text/x-template" id="indexTpl">
			<div>
				<header class="mui-bar mui-bar-nav" id="header">
					<div class="mui-pull-left navicon-edit" @tap="toEditUserinfo"></div>
					<div class="mui-pull-left back-text" @tap="toEditUserinfo">编辑资料</div>
					<h1 id="title" class="mui-title"></h1>
					<div class="mui-pull-right navicon-setting" @tap="toUserSeting"></div>
				</header>
				<div class="mui-content">
					<div class="headimg-warpper">
						<div class="headimg" @tap="selectHeadImg">
							<img :src="UserInfoDetails.headImg" />
						</div>
					</div>
					<div class="userinfo-warpper">
						<p>
							<span>姓名</span>
							<span>{{UserInfoDetails.nickName}}</span>
						</p>
						<p>
							<span>职位</span>
							<span>{{UserInfoDetails.positionName}}</span>
						</p>
						<p>
							<span>出生日期</span>
							<span>{{UserInfoDetails.birthDate}}</span>
						</p>
						<p>
							<span>性别</span>
							<span>{{UserInfoDetails.sex == 0 ? '女' : UserInfoDetails.sex == 1 ? '男' : '保密'}}</span>
						</p>
					</div>
					<div class="userinfo-warpper">
						<p>
							<span>电子邮箱</span>
							<span>{{UserInfoDetails.email}}</span>
						</p>
						<p>
							<span>手机号</span>
							<span>{{UserInfoDetails.phone}}</span>
						</p>
						<p>
							<span>QQ</span>
							<span>{{UserInfoDetails.qq}}</span>
						</p>
						<p>
							<span>地址</span>
							<span>{{UserInfoDetails.address}}</span>
						</p>
					</div>
					<div class="userinfo-warpper">
						<p>
							<span>荣耀</span>
							<span>{{UserInfoDetails.honor}}</span>
						</p>
						<p>
							<span>实践经验</span>
							<span>{{UserInfoDetails.experience}}</span>
						</p>
						<p>
							<span>学历</span>
							<span>{{UserInfoDetails.education}}</span>
						</p>
						<p>
							<span>农务感言</span>
							<span>{{UserInfoDetails.recollections}}</span>
						</p>
					</div>
				</div>
			</div>
		</script>

	</body>
	<script src="../libs/js/mui.min.js"></script>
	<script src="../libs/js/vue.min.js"></script>
	<script src="../js/comm.js"></script>

	<script>
		var vm = new Vue({
			el: '#app',
			template: indexTpl,
			data: function() {
				return {
					loginUserInfo: JSON.parse(localStorage.getItem('loginUserInfo')),
					UserInfoDetails: {},
					// 头像上传路径
					uploadUrl: APIURL + 'business/attachment/createupload',
					// 上传成功返回对象
					uploadResponse: {},
				}
			},
			mounted: function() {
				mui.plusReady(function() {
					var ws = plus.webview.currentWebview();
					ws.setStyle({
						scrollIndicator: 'none'
					});
				})
				var vm = this;
				/**
				 * 获取用户详细信息
				 */
				this.getUserInfoById();
				/**
				 * 监听refresh事件刷新页面
				 */
				window.addEventListener('refresh', function(e) {
					vm.getUserInfoById();
				})
				/**
				 * 监听用户信息变化
				 */
				window.addEventListener('pageflowrefresh', function(event) {

					console.log(JSON.stringify(event.detail))

					vm.getUserInfoById()
				});
			},
			methods: {
				toLogin: function() {
					mui.openWindow({
						url: '../login.html',
						id: 'login'
					})
				},
				/**
				 * 编辑资料
				 */
				toEditUserinfo: function() {
					var vm = this;
					mui.openWindow({
						url: 'index_userInfo_edit.html',
						id: 'index_userInfo_edit',
						extras: {
							UserInfoDetails: vm.UserInfoDetails
						},
						styles: {
							titleNView: { // 窗口的标题栏控件
								titleText: "修改资料",
								backgroundColor: "#70C93E",
								titleColor: "#fff",
								autoBackButton: true,
								titleSize: "18px",
								splitLine: { // 标题栏控件的底部分割线，类似borderBottom
									color: "#70C93E", // 分割线颜色,默认值为"#CCCCCC"  
									height: "1px" // 分割线高度,默认值为"2px"
								}
							}
						}
					})
				},
				/**
				 * 设置页面
				 */
				toUserSeting: function() {
					mui.openWindow({
						url: 'index_userInfo_setting.html',
						id: 'index_userInfo_setting'
					})
				},
				/**
				 * 获取用户详细信息
				 */
				getUserInfoById: function() {
					var vm = this;
					getDataList(APIURL + 'business/user/list', {
						userId: vm.loginUserInfo.userId,
						enterpriseId: vm.loginUserInfo.enterpriseId
					}, function(d) {
						if(d && d.state === 0) {
							if(d.aaData && d.aaData[0]) {
								// 处理头像
								if(d.aaData[0].headPortrait) {
									d.aaData[0].headImg = IMGURL + d.aaData[0].headPortrait + '&image/jpeg';
								} else {
									d.aaData[0].headImg = '../images/often.png';
								}
								// 出生日期
								if(d.aaData[0].birthDate) {
									d.aaData[0].birthDate = d.aaData[0].birthDate.split(' ')[0];
								}

								for(var i in d.aaData[0]) {
									if(d.aaData[0][i] == 'undefined' || d.aaData[0] == undefined) {
										d.aaData[0][i] = '';
									}
								}

								vm.UserInfoDetails = d.aaData[0]
							}
						}
					})
				},
				/**
				 * 选择头像
				 */
				selectHeadImg: function() {
					var vm = this;
					var btnArray = [{
						title: "拍照"
					}, {
						title: "选取现有的"
					}];
					plus.nativeUI.actionSheet({
						title: "选择照片",
						cancel: "取消",
						buttons: btnArray
					}, function(e) {
						var index = e.index;
						switch(index) {
							case 0:
								console.log('取消');
								break;
							case 1:
								vm.byCamera();
								break;
							case 2:
								vm.byAlbum();
								break;
						}
					});
				},
				/**
				 * 调用相机拍照
				 */
				byCamera: function() {
					var vm = this;
					var cmr = plus.camera.getCamera();
					cmr.captureImage(function(path) {
						// 上传
						vm.upload(path)
					}, function(e) {
						console.log('失败：' + e.message)
					}, {
						filename: '_doc/camera/',
						index: 1
					});
				},
				/**
				 * 从相册中选取
				 */
				byAlbum: function() {
					var lfs = null; // 保留上次选择图片列表
					var vm = this;
					plus.gallery.pick(function(e) {
						vm.upload(e)
					}, function(e) {
						mui.toast('取消选择图片');
					}, {
						filter: 'image'
					});
				},
				/**
				 * 上传文件
				 * @param {String} path
				 */
				upload: function(path) {
					console.log(path)
					var vm = this;
					var task = plus.uploader.createUpload(vm.uploadUrl, {
						method: "POST"
					}, function(t, status) { //上传完成
						console.log(t)
						if(status == 200) {
							if(JSON.parse(t.responseText).aaData) {
								// 保存上传成功返回对象
								vm.uploadResponse = JSON.parse(t.responseText).aaData;
								// 赋值保存参数
								vm.UserInfoDetails.headPortrait = JSON.parse(t.responseText).aaData.path;
								// 赋值显示头像的路径
								vm.UserInfoDetails.headImg = IMGURL + JSON.parse(t.responseText).aaData.path + '&image/jpeg';
								// 调用接口保存头像
								console.log(JSON.stringify(vm.UserInfoDetails))
								getDataList(APIURL + 'business/user/updateInfo', vm.UserInfoDetails, function(d) {
									if(d && d.state === 0) {
										mui.toast('头像上传成功');
										vm.getUserInfoById();
									} else {
										mui.toast('头像上传失败');
										vm.getUserInfoById();
									}
								})
							}
							console.log("上传成功：" + t.responseText);
						} else {
							mui.toast("上传头像失败：" + status);
						}
					});
					task.addFile(path, {
						key: 'file'
					});
					task.start();
				},
			}
		});
	</script>
	<script src="../js/immersed.js"></script>

</html>