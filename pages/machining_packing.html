<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>农事助手</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link rel="stylesheet" href="../libs/css/mui.min.css">
		<link rel="stylesheet" href="../libs/css/mui.picker.min.css" />

		<link rel="stylesheet" href="../css/comm.css">
		<style type="text/css">
			.mbtenpx-list .mui-media-body p {
				position: relative; 
				padding-left: 10px;
			}
			.mbtenpx-list .mui-media-body p span {
				display: inline-block;
				width: 4px;
				height: 4px;
				border-radius: 2px;
				position: absolute;
				top: 6px;
				left: 0;
			}
			.mbtenpx-list .mui-media-body p span.bggreen {
				background: #6EC73E;
			}
			.mbtenpx-list .mui-media-body p span.bgblue {
				background: #3ED4FF;
			}
			.mbtenpx-list .mui-media-body p span.bgpurple {
				background: #7DA7FA;
			}
			.mui-bar-tab .baozhuang_db {
				width: 50%;
				color: #777777;
				line-height: 30px;
				font-size: 14px;
				text-align: center;
				margin-top: 20px;
				float: left;
			}
			.mui-bar-tab .baozhuang_db:hover {
				width: 50%;
				color: #70C93E;
				line-height: 30px;
				font-size: 14px;
				text-align: center;
				margin-top: 20px;
				float: left;
			}
			.mui-bar .mui-title {
				left: 90px;
				right: 90px;
			}
			.search-box {
				margin: 0 auto;
				margin-top: 10px;
				width: 96%;
			}
		</style>
	</head>

	<body>
		<div id="app"></div>
		<script type="text/x-template" id="indexTpl">
			<div>
				<header class="mui-bar mui-bar-nav" id="header">
					<div class="mui-action-back mui-pull-left navicon-back1"></div>
					<h1 class="mui-title">包装</h1>
					<div class="mui-pull-right" style="line-height: 45px;" @tap="toAddPacking()">添加</div>
				</header>
				<div style="position: fixed;top: 65px;z-index: 100;width: 100%;">
					<div class="mui-input-row mui-search search-box" v-show="isSearch">
						<input type="search" class="mui-input-clear" placeholder="出入库编号" @blur="search(event)">
					</div>
					<!--查询条件-->
					<div class="mui-row query-condition-warpper">
						<div class="mui-col-xs-6 mui-ellipsis">
							<span @tap="selectWarehouse">{{warehouseName}}</span>
							<img src="../images/jidi_icon_down.png" width="8px" />
						</div>
						<div class="mui-col-xs-6 mui-ellipsis">
							<span @tap="selectHandleUser">{{handleUserName}}</span>
							<img src="../images/jidi_icon_down.png" width="8px" />
						</div>
					</div>
				</div>
				<div class="mui-content" style="padding-top: 80px;">
					<!--列表-->
					<div id="pullrefresh">
						<ul class="mui-table-view mbtenpx-list">
							<li class="mui-table-view-cell mui-media" v-for="d in packageflowList">
								<div class="mui-row">
									<div class="mui-col-sm-9 mui-col-xs-9">
										<div class="mui-media-body">
											<span class="fruit-name" style="font-size: 16px;">{{d.documentTypeName || ''}}</span>
											<template v-if="d.documentDetailList && d.documentTypeName == '包装出库'">
												<p class='mui-ellipsis'><span class="bggreen"></span>产品名称：{{d.documentDetailList[0].templateName || ''}}</p>
												<p class='mui-ellipsis'><span class="bggreen"></span>产品品种：{{d.documentDetailList[0].varietiesName || ''}}</p>
												<p class='mui-ellipsis'><span class="bgblue"></span>出库数量: {{d.documentDetailList[0].quantity || '' + d.documentDetailList[0].unitName || ''}}</p>
											</template>
											<template v-if="d.documentDetailList && d.documentTypeName == '包装入库'">
												<p class='mui-ellipsis'><span class="bggreen"></span>产品名称：{{d.documentDetailList[0].templateName || ''}}</p>
												<p class='mui-ellipsis'><span class="bggreen"></span>产品品种：{{d.documentDetailList[0].varietiesName || ''}}</p>
												<p class='mui-ellipsis'><span class="bgblue"></span>包装单价：{{d.documentDetailList[0].price  || '' + '元/' + d.documentDetailList[0].unitName || ''}}</p>
												<p class='mui-ellipsis'><span class="bgpurple"></span>保质期：{{d.documentDetailList[0].validity || ''}}天</p>
											</template>
											<p class='mui-ellipsis'><span class="bgpurple"></span>出入库时间：{{d.operationDate || ''}}</p>
											<p class='mui-ellipsis'><span class="bgblue"></span>存储仓库: {{d.warehouseName || ''}}</p>
											<p class='mui-ellipsis'><img src="" alt="" /></p>
										</div>
									</div>
									<div class="mui-col-sm-3 mui-col-xs-3 right">
										<div class="mui-pull-right">
											<p class='mui-ellipsis base-area'>{{d.no || ''}}</p>
										</div>
									</div>
								</div>
								<div class="mui-row edit-item">
									<h6 class="mui-col-sm-6 mui-col-xs-6">经办人： {{d.handleUsername || ''}}</h6>
									<h6 class="mui-col-sm-3 mui-col-xs-3" @tap="toEditPacking(d)"><span class="mui-icon mui-icon mui-icon-compose"></span>编辑</h6>
									<h6 class="mui-col-sm-3 mui-col-xs-3" @tap="deleteMachining(d.documentId)"><span class="mui-icon mui-icon mui-icon mui-icon-trash"></span>删除</h6>
								</div>
							</li>
						</ul>
					</div>
				</div>
			</div>
		</script>
	</body>
	<script src="../libs/js/mui.min.js"></script>
	<script src="../libs/js/vue.min.js"></script>
	<script src="../libs/js/mui.picker.min.js"></script>
	<script src="../js/comm.js"></script>

	<script>
		var vm = new Vue({
			el: '#app',
			template: indexTpl,
			data: function() {
				return {
					// 是否显示搜索
					isSearch: false,
					loginUserInfo: JSON.parse(localStorage.getItem('loginUserInfo')),
					// 选择操作人
					pageSize: 10,
					pageNum: 1,
					// 仓库编号（筛选条件）
					no: '',
					// 操作人Id（筛选条件）
					handleUserId: '',
					// 操作人名字
					handleUserName: '全部经办人',
					warehouseId: '',
					warehouseName: '全部仓库',
					// 包装列表
					packageflowList: [],
					// 采收人选择列表
					handleUserList: [{
						value: '',
						text: '全部操作人'
					}],
					// 批次列表
					warehouseList: [{
						value: '',
						text: '全部仓库'
					}],
				}
			},
			mounted: function() {
				// 获取操作人
				this.getUserList();
				// 获取仓库
				this.getWarehouseList();
				// 监听refresh事件刷新页面
				window.addEventListener('refresh', function(e) {
					vm.pageNum = 1;
					vm.getPackageflowList(false);
				})
				mui.plusReady(function(){
					plus.webview.currentWebview().setStyle({scrollIndicator:'none'});
				})
				/**
				 * 下拉加载分页初始化
				 */
				mui.init({
					swipeBack: false,
					pullRefresh: {
						container: '#pullrefresh',
						down: {
							style: 'circle',
							offset: '105px',
							auto: true,
							callback: function() {
								vm.pageNum = 1;
								vm.getPackageflowList(false, function() {
									mui('#pullrefresh').pullRefresh().endPulldown();
								});
							}
						},
						up: {
							contentrefresh: '正在加载...',
							callback: function() {
								++vm.pageNum;
								vm.getPackageflowList(true);
								mui('#pullrefresh').pullRefresh().endPullupToRefresh((vm.pageNum > vm.pageTatol));
							}
						}
					}
				});
			},
			methods: {
				/**
				 * 获取初加工展示列表
				 * @param {Object} isUp
				 */
				getPackageflowList: function(isUp, cb) {
					var vm = this;
					getDataList(APIURL + 'business/document/packageflowList', {
						enterpriseId: vm.loginUserInfo.enterpriseId,
						pageSize: vm.pageSize,
						pageNum: vm.pageNum,
						warehouseId: vm.warehouseId,
						no: vm.no,
						handleUserId: vm.handleUserId
					}, function(d) {
						if(d && d.state === 0) {
							vm.pageTatol = Math.ceil(d.dataCount / vm.pageSize);
							if(d.aaData) {
								console.log(JSON.stringify(d))
								// 处理图片显示
								for(var i in d.aaData) {
									if(d.aaData[i].photo) {
										d.aaData[i].imgurl = IMGURL + d.aaData[i].photo + '&image/jpeg';
									}
									if(d.aaData[i].operationDate){
										d.aaData[i].operationDate = d.aaData[i].operationDate.split(' ')[0] ;
									}
								}

								if(isUp) {
									vm.packageflowList = vm.packageflowList.concat(d.aaData);
								} else {
									vm.packageflowList = d.aaData
								}
							} else {
								if(!isUp) {
									vm.packageflowList = [];
								}
								mui.toast('没有更多数据了')
							}
						}
						cb && cb()
					})
				},
				/**
				 * 选择操作人
				 */
				selectHandleUser: function() {
					offPullrefresh();
					var vm = this;
					var userPicker = new mui.PopPicker();
					userPicker.show(function(items) {
						vm.handleUserId = items[0].value;
						vm.handleUserName = items[0].text;
						vm.pageNum = 1;
						onPullrefresh();
						vm.getPackageflowList(false);
						console.log(vm.handleUserId)
					});
					userPicker.setData(vm.handleUserList);
				},
				/**
				 * 获取操作人员列表
				 */
				getUserList: function() {
					var vm = this;
					getDataList(APIURL + '/business/user/list', {
						enterpriseId: vm.loginUserInfo.enterpriseId,
					}, function(d) {
						if(d && d.state === 0) {
							if(d.aaData) {
								for(var i in d.aaData) {
									var obj = {
										value: d.aaData[i].userId,
										text: d.aaData[i].nickName
									};
									vm.handleUserList.push(obj);
								}
							}
						}
					})
				},
				/**
				 * 选择仓库
				 */
				selectWarehouse: function() {
					offPullrefresh();
					var vm = this;
					var userPicker = new mui.PopPicker();
					userPicker.show(function(items) {
						vm.warehouseId = items[0].value;
						vm.warehouseName = items[0].text;
						vm.pageNum = 1;
						onPullrefresh();
						vm.getPackageflowList(false);
						console.log(vm.warehouseId)
					});
					userPicker.setData(vm.warehouseList);
				},
				/**
				 * 获取仓库列表
				 */
				getWarehouseList: function() {
					var vm = this;
					getDataList(APIURL + 'business/warehouse/list', {
						enterpriseId: vm.loginUserInfo.enterpriseId,
					}, function(d) {
						if(d && d.state === 0) {
							if(d.aaData) {
								for(var i in d.aaData) {
									var obj = {
										value: d.aaData[i].warehouseId,
										text: d.aaData[i].name
									};
									if(d.aaData[i].type != 0) {
										vm.warehouseList.push(obj);
									}
								}
							}
						}
					})
				},
				/**
				 * 获取批次号列表
				 */
				getRecoveryList: function() {
					var vm = this;
					getDataList(APIURL + 'business/recovery/queryRecoveryList', {
						enterpriseId: vm.loginUserInfo.enterpriseId,
					}, function(d) {
						if(d && d.state === 0) {
							if(d.aaData) {
								for(var i in d.aaData) {
									var obj = {
										value: d.aaData[i].batchId,
										text: d.aaData[i].batchId
									};
									vm.RecoveryList.push(obj);
								}
							}
						}
					})
				},
				/**
				 * 添加
				 */
				toAddPacking: function() {
					mui.openWindow({
						url: 'machining_packing_add.html',
						id: 'machining_packing_add',
					})
				},
				/**
				 * 修改
				 * @param {Object} item
				 */
				toEditPacking: function(item) {
					mui.openWindow({
						url: 'machining_packing_add.html',
						id: 'machining_packing_add',
						extras: {
							item: item
						}
					})
				},
				/**
				 * 删除包装
				 * @param {String} documentId
				 */
				deleteMachining: function(documentId) {
					var vm = this;
					var msg = '确认删除?';
					var title = '提示';
					var btnValue = ['确认', '取消'];
					mui.confirm(msg, title, btnValue, function(e) {
						if(e.index == 0) {
							getDataList(APIURL + 'business/document/deletePackageRecordByDocumentId', {
								documentId: documentId,
								enterpriseId: vm.loginUserInfo.enterpriseId
							}, function(d) {
								if(d && d.state === 0) {
									// 先删除列表数据中的
									for(var i in vm.packageflowList) {
										if(vm.packageflowList[i].documentId == documentId) {
											vm.packageflowList.splice(i, 1);
										}
									}
									mui.toast('删除成功');
								} else {
									mui.toast('删除失败');
								}
							})
						}
					})
				},
				/**
				 * 显示搜索框
				 */
				showSearchBox: function() {
					console.log(1111)
					this.isSearch = true;
				},
				/**
				 * 收搜
				 */
				search: function(e) {
					// 这里不用v-modle，不能清除输入内容
					this.no = e.target.value;
					this.getPackageflowList(false);
					// 清空搜索内容
					//this.no = '';
					console.log(this.no)
				}
			}
		});
	</script>
	<script src="../js/immersed.js"></script>

</html>